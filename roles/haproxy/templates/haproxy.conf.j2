global
  log 127.0.0.1 local2
  user        haproxy
  group       haproxy
  daemon
  maxconn     4000
  tune.ssl.default-dh-param 2048

defaults
  log global
  mode  http
  timeout connect 5000
  timeout client 50000
  timeout server 50000

frontend ha-front-ssl
  bind *:443 ssl crt /etc/ssl/private/server.pem
  mode tcp
  option ssl-hello-chk
  default_backend be_roundrobin
  tcp-request inspect-delay 5s  # Allow time to inspect the SNI during the handshake
  {% for server in groups['webserver'] %}
  tcp-request content accept if { req.ssl_sni -i {{ hostvars[server].ansible_fqdn}} }
  {% endfor %}

# Backend Configuration
backend be_roundrobin
  balance roundrobin
  {% for server in groups['webserver'] %}
  server {{ hostvars[server].ansible_nodename }} {{ hostvars[server].inventory_hostname }}:443 ssl verify required ca-file /etc/pki/ca-trust/source/anchors/root-CA.crt check
  {% endfor %}

{% for server in groups['webserver'] %}
backend be_{{ hostvars[server].ansible_nodename }}
    server {{ hostvars[server].ansible_nodename }} {{ hostvars[server].inventory_hostname }}:443 ssl verify required ca-file /etc/pki/ca-trust/source/anchors/root-CA.crt check
{% endfor %}